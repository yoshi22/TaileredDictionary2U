# Phase 3.5 モバイルアプリ準備 実装ログ

**日付:** 2026-01-13
**実施者:** Claude Code
**対象:** TaileredDictionary2U (TD2U) Mobile Application

---

## 概要

Phase 3.5「モバイル準備」の自動化可能なタスクを実装:
1. **Expo プロジェクト初期化** - apps/mobile/ ディレクトリ構築
2. **共有パッケージ連携** - shared-types, shared-srs, shared-utils, shared-validations
3. **認証機能** - Supabase + OAuth (Google/Apple)
4. **基本画面** - ログイン、サインアップ、ダッシュボード、復習、設定
5. **課金準備** - RevenueCat 設定コード
6. **ビルド設定** - EAS Build 設定

---

## 実装内容

### Step 1: プロジェクト基盤

#### 1.1 package.json
**新規**: `apps/mobile/package.json`

主要依存関係:
```json
{
  "dependencies": {
    "expo": "~52.0.0",
    "expo-router": "~4.0.11",
    "expo-auth-session": "~6.0.1",
    "expo-secure-store": "~14.0.0",
    "@supabase/supabase-js": "^2.45.0",
    "@react-native-async-storage/async-storage": "^2.1.0",
    "react-native-purchases": "^8.2.0",
    "@td2u/shared-types": "workspace:*",
    "@td2u/shared-srs": "workspace:*",
    "@td2u/shared-utils": "workspace:*",
    "@td2u/shared-validations": "workspace:*"
  }
}
```

#### 1.2 app.config.ts
**新規**: `apps/mobile/app.config.ts`

Expo 設定:
- Bundle ID: `com.td2u.mobile`
- プラグイン: expo-router, expo-secure-store
- 環境変数: EXPO_PUBLIC_SUPABASE_URL, EXPO_PUBLIC_SUPABASE_ANON_KEY

#### 1.3 eas.json
**新規**: `apps/mobile/eas.json`

EAS Build プロファイル:
- `development`: 開発ビルド (iOS Simulator, Android Internal)
- `preview`: 社内テスト用
- `production`: ストアリリース用

#### 1.4 その他設定ファイル
- `tsconfig.json` - パスエイリアス (@/*, @td2u/*)
- `babel.config.js` - module-resolver プラグイン
- `metro.config.js` - モノレポ対応
- `.env.example` - 環境変数テンプレート

---

### Step 2: コアライブラリ

#### 2.1 Supabase クライアント
**新規**: `apps/mobile/src/lib/supabase.ts`

AsyncStorage を使用したモバイル対応クライアント:
```typescript
export const supabase = createClient(supabaseUrl, supabaseAnonKey, {
  auth: {
    storage: AsyncStorage,
    autoRefreshToken: true,
    persistSession: true,
    detectSessionInUrl: false,
  },
})
```

#### 2.2 OAuth 認証
**新規**: `apps/mobile/src/lib/auth.ts`

Expo Auth Session を使用:
- `signInWithGoogle()` - Google OAuth
- `signInWithApple()` - Apple Sign In
- リダイレクト URI: `${scheme}://auth/callback`

#### 2.3 RevenueCat
**新規**: `apps/mobile/src/lib/purchases.ts`

プレースホルダー実装:
- `initializePurchases()` - SDK 初期化
- `purchasePlusPlan()` - Plus プラン購入
- `purchaseCredits()` - クレジット購入
- `restorePurchases()` - 購入復元

---

### Step 3: フック

#### 3.1 useAuth
**新規**: `apps/mobile/src/hooks/useAuth.ts`

認証状態管理:
- `user` - 現在のユーザー
- `session` - セッション情報
- `isLoading` - ローディング状態
- `signIn()`, `signUp()`, `signOut()`
- `signInGoogle()`, `signInApple()`

#### 3.2 useStats
**新規**: `apps/mobile/src/hooks/useStats.ts`

統計情報取得:
- `v_user_stats` ビューから統計取得
- ローディング/エラー状態管理

---

### Step 4: UI コンポーネント

#### 4.1 Button
**新規**: `apps/mobile/src/components/ui/Button.tsx`

バリアント: `primary`, `secondary`, `outline`, `ghost`
サイズ: `sm`, `md`, `lg`
機能: ローディング状態、無効状態

#### 4.2 Card
**新規**: `apps/mobile/src/components/ui/Card.tsx`

スタイル付きコンテナコンポーネント

#### 4.3 Input
**新規**: `apps/mobile/src/components/ui/Input.tsx`

ラベル、プレースホルダー、エラー表示対応

#### 4.4 カラーテーマ
**新規**: `apps/mobile/src/theme/colors.ts`

Web 版と統一されたカラーパレット

---

### Step 5: ナビゲーション構造

Expo Router によるファイルベースルーティング:

```
app/
├── _layout.tsx           # ルートレイアウト（認証チェック）
├── (public)/             # 未認証ユーザー向け
│   ├── _layout.tsx
│   ├── index.tsx         # ウェルカム画面
│   ├── login.tsx         # ログイン
│   └── signup.tsx        # サインアップ
└── (auth)/               # 認証済みユーザー向け
    ├── _layout.tsx
    └── (tabs)/           # タブナビゲーション
        ├── _layout.tsx
        ├── index.tsx     # ダッシュボード
        ├── review.tsx    # 復習
        └── settings.tsx  # 設定
```

---

### Step 6: 画面実装

#### 6.1 ウェルカム画面
`(public)/index.tsx`
- アプリ紹介
- ログイン/サインアップ誘導

#### 6.2 ログイン画面
`(public)/login.tsx`
- メール/パスワード認証
- Google OAuth ボタン
- Apple Sign In ボタン

#### 6.3 サインアップ画面
`(public)/signup.tsx`
- 新規ユーザー登録
- OAuth オプション

#### 6.4 ダッシュボード
`(auth)/(tabs)/index.tsx`
- 統計表示（総 Entry 数、Due 数、正答率）
- クイックアクション

#### 6.5 復習画面
`(auth)/(tabs)/review.tsx`
- Due エントリー取得
- カードフリップ UI
- 難易度ボタン（Again, Hard, Good, Easy）
- SRS 計算（shared-srs パッケージ使用）

#### 6.6 設定画面
`(auth)/(tabs)/settings.tsx`
- プロフィール表示
- プラン情報
- ログアウト

---

## 技術的な課題と解決

### 課題 1: SrsCalculator API の使用方法

**問題**: shared-srs の SrsCalculator API が不明瞭

**解決**: 正しい API を調査し実装
```typescript
const calculator = new SrsCalculator()
const nextState = calculator.calculate({
  currentState: {
    easeFactor: current.srs.ease_factor,
    intervalDays: current.srs.interval_days,
    repetitions: current.srs.repetitions,
  },
  rating,
  reviewedAt: new Date(),
})
```

### 課題 2: SrsData 型の不一致

**問題**: `SrsData` 型には `id`, `created_at`, `updated_at` が含まれるが、ビューから取得したデータには不要

**解決**: `SimpleSrsData` インターフェースを作成
```typescript
interface SimpleSrsData {
  ease_factor: number
  interval_days: number
  repetitions: number
  due_date: string
  last_reviewed_at: string | null
}
```

### 課題 3: Next.js lockfile パッチングエラー

**問題**: `pnpm build` 時に Next.js 14.2.35 で lockfile パッチングエラー発生
```
TypeError: Cannot read properties of undefined (reading 'os')
```

**解決**:
1. Next.js を 14.2.28 にダウングレード
2. `CI=1` 環境変数でパッチングをスキップ

---

## ビルド検証

### 型チェック
```bash
pnpm --filter mobile type-check  # ✅ パス
```

### モノレポビルド
```bash
CI=1 pnpm build
# ✅ 全6パッケージ成功
# - shared-types, shared-utils, shared-srs, shared-validations: キャッシュヒット
# - web: ビルド成功 (Next.js 14.2.28)
# - mobile: "EAS CLI 要" メッセージ出力（期待通り）
```

---

## 作成ファイル一覧

### 設定ファイル (7)
- `apps/mobile/package.json`
- `apps/mobile/app.config.ts`
- `apps/mobile/eas.json`
- `apps/mobile/tsconfig.json`
- `apps/mobile/babel.config.js`
- `apps/mobile/metro.config.js`
- `apps/mobile/.env.example`

### コアライブラリ (3)
- `apps/mobile/src/lib/supabase.ts`
- `apps/mobile/src/lib/auth.ts`
- `apps/mobile/src/lib/purchases.ts`

### フック (2)
- `apps/mobile/src/hooks/useAuth.ts`
- `apps/mobile/src/hooks/useStats.ts`

### UI コンポーネント (4)
- `apps/mobile/src/components/ui/Button.tsx`
- `apps/mobile/src/components/ui/Card.tsx`
- `apps/mobile/src/components/ui/Input.tsx`
- `apps/mobile/src/components/ui/index.ts`

### テーマ (1)
- `apps/mobile/src/theme/colors.ts`

### ナビゲーション・画面 (10)
- `apps/mobile/app/_layout.tsx`
- `apps/mobile/app/(public)/_layout.tsx`
- `apps/mobile/app/(public)/index.tsx`
- `apps/mobile/app/(public)/login.tsx`
- `apps/mobile/app/(public)/signup.tsx`
- `apps/mobile/app/(auth)/_layout.tsx`
- `apps/mobile/app/(auth)/(tabs)/_layout.tsx`
- `apps/mobile/app/(auth)/(tabs)/index.tsx`
- `apps/mobile/app/(auth)/(tabs)/review.tsx`
- `apps/mobile/app/(auth)/(tabs)/settings.tsx`

### その他 (2)
- `apps/mobile/.gitignore`
- `apps/mobile/assets/README.md`

**合計: 29 ファイル**

---

## 残りの手動タスク

以下は自動化不可のため、手動対応が必要:

1. **EAS プロジェクト初期化**
   ```bash
   cd apps/mobile
   eas init
   ```

2. **RevenueCat ダッシュボード設定**
   - プロジェクト作成
   - API キー取得
   - 商品設定

3. **App Store Connect**
   - アプリ登録
   - IAP 商品作成 (Plus プラン、クレジットパック)

4. **Google Play Console**
   - アプリ登録
   - IAP 商品作成

5. **環境変数設定**
   - Supabase URL/キー (本番)
   - RevenueCat API キー (iOS/Android)

6. **TestFlight / 内部テスト配布**

---

## 次のステップ

1. 実機での動作確認 (`expo start`)
2. 手動タスクの実行
3. Entry 作成画面の追加
4. プッシュ通知対応
5. オフラインサポート

---

## 参考資料

- [Expo Router ドキュメント](https://docs.expo.dev/router/introduction/)
- [Supabase Auth with React Native](https://supabase.com/docs/guides/auth/quickstarts/react-native)
- [RevenueCat React Native SDK](https://www.revenuecat.com/docs/getting-started/installation/reactnative)
- [EAS Build ドキュメント](https://docs.expo.dev/build/introduction/)
